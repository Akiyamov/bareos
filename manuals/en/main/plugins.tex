\chapter{Plugins}
\index[general]{Plugin}

The functionality of Bareos can be extended by plugins.
They do exists plugins for the different daemons (Director, Storage- and File-Daemon).

To use plugins, they must be enabled in the configuration (\configdirective{Plugin Directory} and \configdirective{Plugin Names}).



\section{File Daemon Plugins}
\label{fdPlugins}

File Daemon plugins are configured by the \configdirective{plugin} directive of a FileSet, see the \ilink{File Set}{directive-fileset-plugin} section.

\warning{Currently the plugin command is being stored as part of the backup. The restore command in your directive should be flexible enough if things might change in future, otherwise you could run into trouble.}

\subsection{bpipe Plugin}
\label{bpipe}

The bpipe plugin is a generic pipe program, that simply transmits the data from a specified program to Bareos for backup, and
from Bareos to a specified program for restore. The purpose of the plugin is to provide an interface to any system program
for backup and restore. That allows you, for example, to do database backups without a local dump. By using different command 
lines to bpipe, you can backup any kind of data (ASCII or binary) depending on the program called.

On Linux, the Bareos bpipe plugin is part of the \package{bareos-filedaemon} package and is therefore installed on any system running the filedaemon.

The bpipe plugin is so simple and flexible, you may call it the 
"Swiss Army Knife" of the current existing plugins for Bareos.

The bpipe plugin is specified in the Include section of your Job's FileSet resource in your \file{bareos-dir.conf}.

\begin{bconfig}{bpipe fileset}
FileSet {
  Name = "MyFileSet"
  Include {
    Options {
      signature = MD5
      compression = gzip
    }
    Plugin = "bpipe:<path>:<backup-command>:<restore-command>"
  }
}
\end{bconfig}

The syntax and semantics of the Plugin directive require the first part of the string up to the colon to be the name of the plugin.
Everything after the first colon is ignored by the File daemon but is passed to the plugin. Thus the plugin writer may define the 
meaning of the rest of the string as he wishes. The full syntax of the plugin directive as interpreted by the bpipe plugin is:

\begin{bconfig}{bpipe directive}
Plugin = "<plugin>:<path>:<backup-command>:<restore-command>"
\end{bconfig}

\begin{description}
\item[plugin] is the name of the plugin with the trailing -fd.so stripped off, so in this case, we would put bpipe in the field.

\item[path] specifies the namespace, which for bpipe is the pseudo path and filename under which the backup will be saved. This
pseudo path and filename will be seen by the user in the restore file tree. For example, if the value is /MySQL/mydump.sql, the data
backed up by the plugin will be put under that "pseudo" path and filename. You must be careful to choose a naming convention that is unique
to avoid a conflict with a path and filename that actually exists on your system.

\item[backup-command] for the bpipe plugin specifies the "reader" program that is called by the plugin during backup to read the data. bpipe
will call this program by doing a popen on it.

\item[restore-command] for the bpipe plugin specifies the "writer" program that is called by the plugin during restore to write the data back 
to the filesystem.
\end{description}

Please note that the two items above describing the "reader" and "writer", these programs are "executed" by Bareos, which means 
there is no shell inerpretation of any command line arguments you might use. If you want to use shell characters (redirection of input 
or output, ...), then we recommend that you put your command or commands in a shell script and execute the script. In addition if you
backup a file with reader program, when running the writer program during the restore, Bareos will not automatically create the path
to the file. Either the path must exist, or you must explicitly do so with your command or in a shell script.

See the examples about \ilink{Backup PostgreSQL}{backup-postgresql} and \ilink{Backup MySQL}{backup-mysql}.


\subsection{PGSQL Plugin}

See chapter \ilink{Backup of a PostgreSQL Databases by using the PGSQL-Plugin}{backup-postgresql-plugin}.


\subsection{MSSQL Plugin}

See chapter \ilink{Backup Of MSSQL Databases}{MSSQL}.


\subsection{python-fd Plugin}
\index[general]{Plugin!Python!File Daemon}

The \name{python-fd} plugin behaves similar to the \ilink{python-dir}{director-python-plugin} plugin.
Please read the information there.



\section{Storage Daemon Plugins}
\label{sdPlugins}

\subsection{autoxflate-sd}

This plugin is part of the \package{bareos-storage} package.

The autoxflate-sd plugin can inflate(decompres) and deflate(compress)
the data being written to or read from a device. It can also do both.

[autoxflate-functionblocks.png]

Therefore the autoxflate plugin inserts a inflate and a deflate function block
into the stream going to the device (called OUT) and coming from the device (called IN).

Each stream passes first the inflate function block, then the deflate funcion block.

The inflate blocks are controlled by the setting of the \directive{sd}{autoinflate}{yes{\textbar}no}{}{yes}{}
directive.

The deflate blocks are controlled by the setting of the \directive{sd}{autodeflate}{yes{\textbar}no}{}{yes}{}
\directive{sd}{autodeflatealgorithm}{yes{\textbar}no}{}{yes}{} and  \directive{sd}{autodeflatelevel}{yes{\textbar}no}{}{yes}{} .


\directive{sd}{autodeflate}{yes{\textbar}no}{}{yes}{} \directive{sd}{autoinflate}{yes{\textbar}no}{}{yes}{} control if the
function block is enabled at all.
Possible values are:
\begin{description}
 \item [in] inflation / deflation is enabled on the incoming data path.
 \item [out] inflation / deflation is enabled ont the outgoing data path.
 \item [both] inflation / deflation is enabled both for incoming and outgoing data.
\end{description}

The \directive{sd}{autodeflatealgorithm}{yes{\textbar}no}{}{yes}{} selects the algorithm used for deflation,
and can be one of the supported compression algorithms: gzip / lzo / lzfast / lz4 / lz4hc.
If the compression algorithm supports the selection of compression level like gzip, this level can be configured in \directive{sd}{autodeflatelevel}{yes{\textbar}no}{}{yes}{}

The inflate blocks, if enabled, will uncompress data if it is compressed using the
algorithm that was used during compression.

The deflate blocks, if enabled, will compress uncompressed data with the algorithm and level configured in the according directives.

The series connection of the inflate and deflate function blocks makes the plugin very flexible.

Szenarios where this plugin can be used are for example:

- client computers with weak cpus can do backups without compression and
  let the sd do the compression when writing to disk.

- compressed backups can be recompressed to a different compression format (e.g. gzip -> lzo) using migration jobs

- client backups can be compressed with compression algorithms that the client itself does not support.

Multi-core cpus will be utilized when using parallel jobs as the compression is done in each jobs' thread.

When the autoxflate plugin is configured, it will write some status information into the joblog.

This information shows what compression algorithm is used:
autodeflation: compressor on device FileStorage is FZ4H

How the inflation and deflation blocks are configured:
autoxflate-sd.c: FileStorage OUT:[SD->inflate=yes->deflate=yes->DEV] IN:[DEV->inflate=yes->deflate=yes->SD]

And how the overall deflation/inflation ratio was:
autoxflate-sd.c: deflate ratio: 50.59%

\subsection{scsicrypto-sd}

This plugin is part of the \package{bareos-storage} package.

\subsection{scsitapealert-sd}

This plugin is part of the \package{bareos-storage-tape} package.


\subsection{python-sd Plugin}
\index[general]{Plugin!Python!Storage Daemon}

The \name{python-sd} plugin behaves similar to the \ilink{python-dir}{director-python-plugin} plugin.
Please read the information there.


\section{Director Plugins}
\label{dirPlugins}

\subsection{python-dir Plugin}
\label{director-python-plugin}
\index[general]{Plugin!Python!Director}

The \name{python-dir} plugin is intended to extend the functionality of the Bareos Director by Python code.
A working example is included.

\begin{itemize}
    \item install the \package{bareos-director-python-plugin} package
    \item change to the Baroes plugin directory (\directory{/usr/lib/bareos/plugins/} or \directory{/usr/lib64/bareos/plugins/})
    \item copy \file{bareos-dir.py.template} to \file{bareos-dir.py}
    \item activate the plugin in the Bareos Director configuration
    \item restart the Bareos Director
    \item change \file{bareos-dir.py} as required
    \item restart the Bareos Director
\end{itemize}

\subsubsection*{Limitations}

\begin{itemize}
    \item Currently there can be only one Python plugin per Director. The plugin only loads the file \file{bareos-dir.py}.
\end{itemize}
